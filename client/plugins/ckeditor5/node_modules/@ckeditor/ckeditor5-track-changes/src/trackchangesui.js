/*
 *             Copyright (c) 2016 - 2020, CKSource - Frederico Knabben. All rights reserved.
 *
 *
 *
 *
 *          +---------------------------------------------------------------------------------+
 *          |                                                                                 |
 *          |                                 Hello stranger!                                 |
 *          |                                                                                 |
 *          |                                                                                 |
 *          |   What you're currently looking at is the source code of a legally protected,   |
 *          |    proprietary software. Any attempts to deobfuscate / disassemble this code    |
 *          |               are forbidden and will result in legal consequences.              |
 *          |                                                                                 |
 *          |                                                                                 |
 *          +---------------------------------------------------------------------------------+
 *
 *
 *
 *
 */
import _0x226497 from'@ckeditor/ckeditor5-core/src/plugin';import _0x4b7aaa from'./trackchangesediting';import _0x2efe2f from'@ckeditor/ckeditor5-comments/src/comments/commentsrepository';import Ct from'./ui/suggestioncontroller';import bt from'./ui/view/suggestionthreadview';import _0x5d9338 from'@ckeditor/ckeditor5-collaboration-core/src/users';import Tt from'@ckeditor/ckeditor5-comments/src/annotations/annotations';import xt from'@ckeditor/ckeditor5-comments/src/annotations/editorannotations';import Et from'@ckeditor/ckeditor5-ui/src/model';import At from'@ckeditor/ckeditor5-utils/src/collection';import St from'@ckeditor/ckeditor5-ui/src/dropdown/button/splitbuttonview';import{createDropdown as vt,addListToDropdown as Nt}from'@ckeditor/ckeditor5-ui/src/dropdown/utils';import Dt from'@ckeditor/ckeditor5-comments/src/utils/getdatetimeformatter';import It from'@ckeditor/ckeditor5-comments/src/utils/getmarkerdomelement';import Ut from'../theme/icons/track-changes.svg';import{debounce as Wt}from'lodash-es';export default class d extends _0x226497{static get['requires'](){return[Tt,xt,_0x4b7aaa,_0x2efe2f,_0x5d9338];}static get['pluginName'](){return'TrackChangesUI';}constructor(_0x76185a){super(_0x76185a),this['_suggestionToController']=new Map(),this['_viewToController']=new Map(),this['_debouncedHandlers']=new Map(),this['editor']['config']['define']('trackChanges.SuggestionThreadView',bt);}['init'](){const _0x4d2a43=this['editor'],_0x443fe7=_0x4d2a43['plugins']['get']('TrackChangesEditing'),_0x2464f3=_0x4d2a43['plugins']['get']('Annotations'),_0x52f210=_0x4d2a43['plugins']['get']('EditorAnnotations'),_0x359d7c=_0x4d2a43['plugins']['get']('CommentsRepository');_0x4d2a43['ui']['componentFactory']['add']('trackChanges',_0x1719b3=>this['_createUIButton'](_0x1719b3)),_0x52f210['addSourceCollector'](()=>{const _0x1492c5=[];for(const [_0xafe0e7,_0x3a350a]of Array['from'](this['_suggestionToController'])){const _0xa268a0=_0xafe0e7['getAllAdjacentSuggestions'](),_0x33f5d1=[];for(const _0x4b3779 of _0xa268a0){const _0x4fe279=_0x4b3779['getRanges']();for(let _0x29eef4=0x0;_0x29eef4<_0x4fe279['length'];_0x29eef4++)0x0==_0x29eef4&&_0x33f5d1['length']>0x0?_0x33f5d1[0x0]['end']=_0x4fe279[0x0]['end']['clone']():_0x33f5d1['push'](_0x4fe279[_0x29eef4]);}_0x1492c5['push']([_0x3a350a['view'],_0x33f5d1]);}return _0x1492c5;}),this['listenTo'](_0x443fe7,'suggestionLoaded',(_0x20fd60,_0x135e79)=>{let _0x57edd3=!0x1;const _0x34df56=Wt(_0x3848b7=>{_0x57edd3||_0x3848b7?_0x57edd3&&_0x3848b7&&(this['_destroyController'](_0x135e79),_0x52f210['refreshSelectedViews'](),_0x57edd3=!0x1):(this['_initializeController'](_0x135e79),_0x52f210['refreshSelectedViews'](),_0x57edd3=!0x0);},0xa);this['_debouncedHandlers']['set'](_0x135e79,_0x34df56),this['listenTo'](_0x135e79,'change:previous',(_0x2021c1,_0xab7071,_0xc3a67d,_0x439752)=>{_0x135e79['isInContent']&&(null==_0xc3a67d?(this['_updateController'](_0x439752['head']),_0x34df56(!0x1)):(this['_updateController'](_0xc3a67d['head']),_0x34df56(!0x0)));}),null===_0x135e79['previous']?_0x34df56(!0x1):this['_updateController'](_0x135e79['head']);}),this['listenTo'](_0x443fe7,'suggestionUnloaded',(_0x2c90d4,_0x5988d0,_0x344721)=>{this['stopListening'](_0x5988d0,'change:previous'),this['_debouncedHandlers']['get'](_0x5988d0)['cancel'](),this['_debouncedHandlers']['delete'](_0x5988d0);const _0x47899d=_0x344721?_0x344721['head']:_0x5988d0,_0x5ea628=this['_suggestionToController']['get'](_0x47899d);null!==_0x344721&&this['_updateController'](_0x47899d),null===_0x344721&&_0x5ea628&&this['_destroyController'](_0x5988d0);}),this['listenTo'](_0x443fe7,'suggestionChanged',(_0x51747e,_0x26f7cb)=>{this['_updateController'](_0x26f7cb);}),this['listenTo'](_0x2464f3,'change:activeView',(_0x4bbc19,_0x48564e,_0x5ead06,_0x4951a2)=>{if(_0x4951a2&&this['_viewToController']['has'](_0x4951a2)&&(_0x4951a2['isActive']=!0x1),_0x5ead06&&this['_viewToController']['has'](_0x5ead06)){const _0x42a576=this['_viewToController']['get'](_0x5ead06)['model']['getAllAdjacentSuggestions']();_0x5ead06['isActive']=!0x0,_0x443fe7['activeMarkers']=_0x42a576['reduce']((_0x1448a3,_0xfa112c)=>[..._0x1448a3,..._0xfa112c['getMarkerNames']()],[]);}else _0x443fe7['activeMarkers']=[];}),this['listenTo'](_0x359d7c,'addComment',(_0x496211,{threadId:_0x3fa770,isFromAdapter:_0x4de3df})=>{if(_0x4de3df||!_0x443fe7['hasSuggestion'](_0x3fa770))return;const _0x5c3b3f=_0x443fe7['getSuggestion'](_0x3fa770);this['_suggestionToController']['get'](_0x5c3b3f)['view']['focus']();},{'priority':'lowest'});}['_createUIButton'](_0x3dbba4){const _0x3a5289=vt(_0x3dbba4,St),_0xd22fbc=this['editor']['commands']['get']('trackChanges'),{t:t}=this['editor'];_0x3a5289['buttonView']['set']({'tooltip':t('Track\x20changes'),'label':t('Track\x20changes'),'icon':Ut}),_0x3a5289['buttonView']['bind']('isOn')['to'](_0xd22fbc,'value'),_0x3a5289['buttonView']['on']('execute',()=>_0xd22fbc['execute']());const _0x1f6dd6=new At(),_0x196517=[{'type':'switchbutton','model':{'withText':!0x0,'label':t('Track\x20changes'),'commandName':'trackChanges'}},{'type':'separator'},{'type':'button','model':{'withText':!0x0,'label':t('Accept\x20all\x20suggestions'),'commandName':'acceptAllSuggestions'}},{'type':'button','model':{'withText':!0x0,'label':t('Accept\x20all\x20selected\x20suggestions'),'commandName':'acceptSelectedSuggestions'}},{'type':'button','model':{'withText':!0x0,'label':t('Discard\x20all\x20suggestions'),'commandName':'discardAllSuggestions'}},{'type':'button','model':{'withText':!0x0,'label':t('Discard\x20all\x20selected\x20suggestions'),'commandName':'discardSelectedSuggestions'}}];for(const _0x5b5be6 of _0x196517){const _0x2c5070={'type':_0x5b5be6['type']};if(_0x5b5be6['model']){const _0x775914=new Et(_0x5b5be6['model']),_0x30f6ba=this['editor']['commands']['get'](_0x775914['commandName']);_0x775914['bind']('isOn','isEnabled')['to'](_0x30f6ba,'value','isEnabled'),_0x2c5070['model']=_0x775914;}_0x1f6dd6['add'](_0x2c5070);}Nt(_0x3a5289,_0x1f6dd6);const _0x4bb79b=_0x196517['filter'](_0x2f7a67=>null!=_0x2f7a67['model'])['map'](_0x164d81=>this['editor']['commands']['get'](_0x164d81['model']['commandName']));return _0x3a5289['buttonView']['actionView']['unbind']('isEnabled'),_0x3a5289['buttonView']['arrowView']['unbind']('isEnabled'),_0x3a5289['buttonView']['actionView']['bind']('isEnabled')['to'](_0xd22fbc,'isEnabled'),_0x3a5289['buttonView']['arrowView']['bind']('isEnabled')['toMany'](_0x4bb79b,'isEnabled',(..._0x5525ea)=>_0x5525ea['some'](_0x422534=>_0x422534)),_0x3a5289['on']('execute',_0xc6ff9e=>this['editor']['execute'](_0xc6ff9e['source']['commandName'])),_0x3a5289;}['_initializeController'](_0x30147d){const _0x37dffe=this['editor'],_0x4e5669=_0x37dffe['config'],_0x283479=_0x37dffe['plugins']['get']('Annotations'),_0x3d1d44=_0x30147d['getAllAdjacentSuggestions']()['filter'](_0x22a2a2=>_0x22a2a2['isInContent']),_0x26f3db=_0x37dffe['plugins']['get']('Users')['me'],_0x22025f=_0x37dffe['commands']['get']('acceptSuggestion'),_0x5ee173=_0x37dffe['commands']['get']('discardSuggestion'),_0x4df1b6=new(0x0,(_0x4e5669['get']('trackChanges'))['SuggestionThreadView'])(_0x37dffe['locale'],_0x30147d,_0x26f3db,{'editorConfig':_0x4e5669['get']('comments.editorConfig'),'maxCommentsWhenCollapsed':_0x4e5669['get']('comments.maxCommentsWhenCollapsed'),'maxThreadTotalWeight':_0x4e5669['get']('comments.maxThreadTotalWeight'),'maxCommentCharsWhenCollapsed':_0x4e5669['get']('comments.maxCommentCharsWhenCollapsed'),'formatDateTime':Dt(_0x4e5669['get']('locale')),'CommentView':_0x4e5669['get']('comments')['CommentView']}),_0xdc7409=new Ct(_0x30147d,_0x4df1b6,_0x22025f,_0x5ee173);_0x4df1b6['descriptionParts']=_0x37dffe['plugins']['get']('TrackChangesEditing')['_descriptionFactory']['getDescriptions'](_0x3d1d44),this['_suggestionToController']['set'](_0x30147d,_0xdc7409),this['_viewToController']['set'](_0x4df1b6,_0xdc7409);const _0x4fee73=_0x283479['add'](_0x4df1b6,()=>{const _0x500e18=_0x3d1d44[0x0]['getFirstMarker']();return _0x500e18&&It(_0x37dffe['editing'],_0x500e18)||null;});_0x4fee73['bind']('type')['to'](_0xdc7409['view'],'type',_0x537456=>'suggestion-'+_0x537456),_0x4fee73['bind']('hasChanges')['to'](_0x4df1b6,'isDirty'),_0x4fee73['bind']('length')['to'](_0x4df1b6);const _0x52cc75=_0x37dffe['plugins']['get']('PendingActions');let _0x316153;_0x4df1b6['on']('change:isDirty',(_0x26091f,_0x997294,_0x116c04)=>{if(_0x116c04){const t=this['editor']['locale']['t'];_0x316153=_0x52cc75['add'](t({'string':'Unsaved\x20change\x20in\x20suggestion.','id':'PENDING_ACTION_SUGGESTION'}));}else _0x52cc75['remove'](_0x316153),_0x316153=null;});}['_destroyController'](_0x289fac){const _0x4bc945=this['editor']['plugins']['get']('Annotations'),_0x140d1f=this['_suggestionToController']['get'](_0x289fac),_0x4ae07e=_0x140d1f['view'];_0x4bc945['remove'](_0x4ae07e),this['_suggestionToController']['delete'](_0x289fac),this['_viewToController']['delete'](_0x4ae07e),_0x140d1f['destroy'](),_0x4ae07e['destroy']();}['_updateController'](_0x62176){if(!this['_suggestionToController']['has'](_0x62176))return;const _0x3ad0ce=this['editor']['plugins']['get']('TrackChangesEditing'),_0x55dc63=this['_suggestionToController']['get'](_0x62176),_0x3fbed2=_0x62176['getAllAdjacentSuggestions']();_0x55dc63['view']['descriptionParts']=_0x3ad0ce['_descriptionFactory']['getDescriptions'](_0x3fbed2);}['destroy'](){super['destroy']();for(const _0x1997f4 of this['_suggestionToController']['keys']())this['_destroyController'](_0x1997f4);for(const _0x41d244 of this['_debouncedHandlers']['values']())_0x41d244['cancel']();this['_debouncedHandlers']['clear']();}}